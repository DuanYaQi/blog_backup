# 前言

最近在学习软件调试相关的内容，顺便举一反三找找反调试以及反反调试的相关方法。逛着逛着找到了这个网站：[2种基于异常机制的反调试方法](https://blog.csdn.net/lixiangminghate/article/details/47950929)，虽然一看就知道不知道从哪转载的，而且搜索引擎有很多这篇文章一模一样的重复结果，但是代码倒是挺有趣的，研究玩玩。

# 第一题

第一段代码是基于`IsDebugPresent()`类似实现的反调试，代码如下

```cpp
#include <windows.h>
 
int AntiDebugInSEH(EXCEPTION_POINTERS* ExceptionInfo)
{
	DWORD state = 0x00;
 
	__asm
	{
		mov eax,dword ptr fs:[30h];
		movzx eax, byte ptr ds:[eax+2h];
		mov state,eax;
	}
 
	ExceptionInfo->ContextRecord->Eax = state;
	ExceptionInfo->ContextRecord->Eip = 0x06+(DWORD)ExceptionInfo->ExceptionRecord->ExceptionAddress;
	return EXCEPTION_CONTINUE_EXECUTION;
}
 
int main()
{
	int i=0;
	__try
	{
		__asm
		{
			xor eax,eax;
			mov dword ptr [eax],0; //触发异常
		}
		__asm
		{
                    //异常返回后，eax的值为AntiDebugInSEH中ExceptionInfo->ContextRecord->Eax设定的值                    
                    mov i,eax
		}
		if(i==1)
		{}
		else
		{
			MessageBox(NULL,"","",0);
		}
		i++;
	}
	__except(AntiDebugInSEH(GetExceptionInformation()))
	{
		
	}
}

```

程序的流程为通过主动引发异常跳转入异常处理函数，在异常处理函数内部查看`fs:[30h]+2h`的值，如果为1则不显示任何结果，为0则弹出一个空窗口。在着手这个程序前，先来看看`IsDebugPresent`究竟是何方神圣。

## IsDebugPresent()

VC中有一个用于检测调试状态的API`IsDebugPresent()`，当程序处于被调试状态时，该API返回`True`。出于对软件的保护，我们在程序的变量初始化前就调用该API检测调试情况。代码如下：

```cpp
#include<iostream>
#include<stdio.h>
#include<stdlib.h>
#include<Windows.h>

int main()
{
    if (IsDebuggerPresent())//检测是否处于被调试状态
    {
        std::cout << "this program can not run in debugger!";
        getchar();
        return E_FAIL;
    }

    CONTEXT thread_context;//上下文结构体
    HANDLE hThread = GetCurrentThread();//获取当前进程的句柄
    DWORD test_var = 0;

    thread_context.ContextFlags = CONTEXT_DEBUG_REGISTERS | CONTEXT_FULL;//设置线程上下文的类型
    if (!GetThreadContext(hThread, &thread_context))//通过句柄获取进程的上下文
    {
        std::cout << "Failed to get thread context.";
        return E_FAIL;
    }

    thread_context.Dr0 = (DWORD)& test_var;//将DR0设置为test_var的地址
    thread_context.Dr7 = 0xF0001;//F代表4字节读写访问断点，01代表启用DR0断点
    if (!SetThreadContext(hThread, &thread_context))//将线程上下文应用于句柄所指向的线程
    {
        std::cout << "Failed to set thread context";
        return E_FAIL;
    }

    test_var = 1;//修改test_var的值，触发断点
    GetThreadContext(hThread, &thread_context);//获取修改后的线程上下文
    printf("DR6:%x",thread_context.Dr6);
    getchar();
    return S_OK;
}
```

上述代码在VS2017编译后，直接在IDE里执行会报告检测到调试器——即使没有下任何断点。

![](https://tinytracer-1256246079.cos.ap-guangzhou.myqcloud.com/Debug/4-5.png)

如果不在调试环境下运行，由于后续会触发调试异常，没有调试器处理，双击执行程序会导致闪退，在命令行运行会导致程序死锁。有没有方法绕过这个API来继续程序的执行呢？

### 原理

用户态调用的`IsDebugPresent`会转换到内核态中的`IsDebugPresent`，其汇编代码如下：

```assembly
    KERNELBASE!IsDebuggerPresent:
76d0b940 64a130000000 mov     eax, dword ptr fs:[00000030h] fs:0053:00000030=0035b000
76d0b946 0fb64002     movzx   eax, byte ptr [eax+2]
76d0b94a c3           ret     
76d0b94b cc           int     3
76d0b94c cc           int     3
76d0b94d cc           int     3
76d0b94e cc           int     3
76d0b94f cc           int     3
```

该API首先会将fs寄存器偏移`0x30`的地址传入`EAX`寄存器中，然后提取`EAX`所指向地址偏移2字节的值传入eax中，最后返回。为什么检测调试指令要读取一个固定地址的值？实际上，进程的PEB常存储于fs寄存器加上特定偏移量的地址中。`IsDebugPresent`监视的是进程PEB结构体中`BeingDebugged`域的值，当该位为1时，代表进程正处于被调试状态。下面是Windbg中peb的结构体说明：

```cpp
0:000> dt _PEB
ntdll!_PEB
   +0x000 InheritedAddressSpace : UChar
   +0x001 ReadImageFileExecOptions : UChar
   +0x002 BeingDebugged    : UChar
   +0x003 BitField         : UChar
   +0x003 ImageUsesLargePages : Pos 0, 1 Bit
   +0x003 IsProtectedProcess : Pos 1, 1 Bit
   +0x003 IsImageDynamicallyRelocated : Pos 2, 1 Bit
   +0x003 SkipPatchingUser32Forwarders : Pos 3, 1 Bit
   +0x003 IsPackagedProcess : Pos 4, 1 Bit
......
```

下面来看看`fs:[30]`对应地址存储的信息

```assembly
0:000> dg fs
                                  P Si Gr Pr Lo
Sel    Base     Limit     Type    l ze an es ng Flags
---- -------- -------- ---------- - -- -- -- -- --------
0053 0091f000 00000fff Data RW Ac 3 Bg By P  Nl 000004f3

0:000> dd 0091f000+0x30
0091f030  0091c000 00000000 00000000 00000000

0:000> dt _PEB 0091c000
ntdll!_PEB
   +0x000 InheritedAddressSpace : 0 ''
   +0x001 ReadImageFileExecOptions : 0 ''
   +0x002 BeingDebugged    : 0x1 ''
   +0x003 BitField         : 0x4 ''
   +0x003 ImageUsesLargePages : 0y0
   +0x003 IsProtectedProcess : 0y0
   +0x003 IsImageDynamicallyRelocated : 0y1
   +0x003 SkipPatchingUser32Forwarders : 0y0
 ......
```

PEB是一个庞大的结构体，可以看到，PEB基址偏移`0x2`处的域刚好就是`BeingDebugged`。至此，通过`IsDebugPresent()`反调试的原理已经被摸清，下面来看看怎么绕过。

### 绕过方式

- 最简单的当然是修改寄存器的值。首先通过`bp KERNELBASE!IsDebuggerPresent`在内核API调用前让程序停下来，在`ret`执行前使用`r @eax=0`修改EAX的值——大功告成。

- 复杂但究其根源的方法是修改程序的PEB，将调试位置0。比较方便的方法为先通过`dg`获取`fs`寄存器指向的基址，然后通过`eb`指令将对应位置置0。

  ```cpp
  0:000> dg fs
                                    P Si Gr Pr Lo
  Sel    Base     Limit     Type    l ze an es ng Flags
  ---- -------- -------- ---------- - -- -- -- -- --------
  0053 00e05000 00000fff Data RW Ac 3 Bg By P  Nl 000004f3
      
  0:000> eb poi(00e05000+0x30)+2 0
  ```

回到题目，可以发现，题目中以下语句

```assembly
mov eax,dword ptr fs:[30h];
movzx eax, byte ptr ds:[eax+2h];
mov state,eax;
```

是不是就是读取_PEB中`BeingDebugged`字段的汇编语句，由此得出，绕过的方式与我实现的示例程序一样，修改对应字段的值就好。

# 第二题

首先，第二题在网站中并没有解答...网页上的原文是

> 这段代码，还是读者自己试下，我暂时没想到如果绕过检测的方法。

这么多重复的文章，抄来抄去的，居然连这句也一并抄了，就不会动动脑子解决掉吗

![âæTMâçå¾çæç´¢ç"æ](data:image/jpeg;base64,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)

算了，挖挖看看。照例先上题目源码

```cpp
#include <windows.h>
 
LONG WINAPI UnhandledExcept(EXCEPTION_POINTERS *pExpInfo)  
{
	if(pExpInfo->ExceptionRecord->ExceptionCode != EXCEPTION_BREAKPOINT)
	{
		return EXCEPTION_EXECUTE_HANDLER;
	}
	else
	{
		pExpInfo->ContextRecord->Eip = (DWORD)(pExpInfo->ContextRecord->Eip+1);
		pExpInfo->ContextRecord->Eax = 0x0000FEEE;
		return EXCEPTION_CONTINUE_EXECUTION;
	}
}
 
int main()
{
	HMODULE hMod = LoadLibrary("kernel32.dll");
	DWORD* funcAddr = (DWORD*)GetProcAddress(hMod,"ExitProcess");
	
	SetUnhandledExceptionFilter(UnhandledExcept);
	_asm int 3;
	__asm
	{
		cmp ax,0xFEEE;
		jz next;
		push 0;
		mov eax,funcAddr;
		call eax;
next:
	}
	{
		MessageBox(NULL,"","",MB_OK);
	}
}

```

嗯，通过断点异常来让调试器捕获，于是无法执行程序中内置的异常处理流程，导致程序直接退出。看起来就像是*先有鸡还是先有蛋*的的悖论，连接上了调试器断点肯定得断，不连接就无法获取程序的信息。但是`INT 3`断点异常是陷阱，改个`EIP`就能过去，为了硬核一点，我对程序进行了小小的修改，将异常改为除0异常，如果不执行程序内部的异常处理，调试器将永远卡在一个地方，改`EIP`也木得用。

```cpp
#include<iostream>
#include<stdio.h>
#include<stdlib.h>
#include<Windows.h>
DWORD flag = 0;
void __stdcall succ()
{
    MessageBox(NULL, "NoDebug", "Good", MB_OK);
}

void __stdcall fail()
{
    MessageBox(NULL, "Debug!", "Oops", MB_OK);
}

LONG WINAPI UnhandledExcept(EXCEPTION_POINTERS *pExpInfo)
{

    pExpInfo->ContextRecord->Eip = (DWORD)(pExpInfo->ContextRecord->Eip +0xB);
    pExpInfo->ContextRecord->Eax = 0x0000FEEE;
    return EXCEPTION_CONTINUE_EXECUTION;
}

int main()
{
    HMODULE hMod = LoadLibrary("kernel32.dll");
    DWORD* funcAddr = (DWORD*)GetProcAddress(hMod, "ExitProcess");
    SetUnhandledExceptionFilter(UnhandledExcept);
    flag = 6 / flag;//引发除0异常
    __asm
    {
        cmp eax, 0x0000FEEE;
        jz next;
        mov eax, fail;
        call eax;
        push 0;
        mov eax, funcAddr;
        call eax;
    next:
        mov eax, succ;
        call eax;
    }
    return 0;
}
```

这货在VS2017中编译运行的情况是这样的

![](https://tinytracer-1256246079.cos.ap-guangzhou.myqcloud.com/Debug/db-1.png)

点击继续无法运行，一直卡在了异常报错处。在Windbg中也好不到哪去

```cpp
0:000> g
(1f84.3ea0): Integer divide-by-zero - code c0000094 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000006 ebx=0048b000 ecx=a5e70000 edx=00000000 esi=0032fa08 edi=0032faf0
eip=003b19a5 esp=0032fa08 ebp=0032faf0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
Breakpoints!main+0x75:
003b19a5 f73538a13b00    div     eax,dword ptr [Breakpoints!flag (003ba138)] ds:002b:003ba138=00000000

0:000> g
(1f84.3ea0): Integer divide-by-zero - code c0000094 (!!! second chance !!!)
eax=00000006 ebx=0048b000 ecx=a5e70000 edx=00000000 esi=0032fa08 edi=0032faf0
eip=003b19a5 esp=0032fa08 ebp=0032faf0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
Breakpoints!main+0x75:
003b19a5 f73538a13b00    div     eax,dword ptr [Breakpoints!flag (003ba138)] ds:002b:003ba138=00000000
```

就像军训的“一二一”一样不停地循环报错。双击直接运行，嗯，温顺得不得了

![](https://tinytracer-1256246079.cos.ap-guangzhou.myqcloud.com/Debug/db-2.png)

成了，十分符合题目的要求，接下来开搞！

### 失败的尝试-1

首先联想到的是其底层实现可能与`IsDebugPresent`一样，通过检测PEB中的`BeingDebugging`位来判断是否将异常传递给调试器。那就改来试试

```cpp
0:000> dg fs
                                  P Si Gr Pr Lo
Sel    Base     Limit     Type    l ze an es ng Flags
---- -------- -------- ---------- - -- -- -- -- --------
0053 009a1000 00000fff Data RW Ac 3 Bg By P  Nl 000004f3

0:000> eb poi(009a1000+0x30)+2 0

0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (first chance)

0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (!!! second chance !!!)
```

死循环，看来系统的异常分发机制与该标志位无关。改下EIP强行跳转到下一条语句？

```cpp
0:000> r @eip=003b19ab

0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (first chance)
eip=003b19a5

0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (!!! second chance !!!)
eip=003b19a5
```

不仅还是陷入了死循环，而且EIP还跳回去了。

### 失败的尝试-2

搜索了一番与反调试相关的文章教程，发现了一篇挺不错的文章[[How to debug UnhandleExceptionHandler!](https://grapef.wordpress.com/2006/06/19/how-to-debug-unhandleexceptionhandler/)]，刚好适用于这种情况。文章的第一步

> **1. put a bp on kernel32!UnhandledExceptionFilter**

然而我打开windbg，得到的是这样的结果

```
0:000> bp kernel32!UnhandledExceptionFilter
Couldn't resolve error at 'kernel32!UnhandledExceptionFilter'
```

![âçº³å°¼âçå¾çæç´¢ç"æ](data:image/jpeg;base64,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)

是不是我没下符号表...是不是没加载`kernel32`的模块...吓得我赶紧lm看看

```cpp
0:000> lm
start    end        module name
003a0000 003c0000   Breakpoints C (private pdb symbols)  F:\OneDrive\cpp\Breakpoints\Debug\Breakpoints.pdb
0f0e0000 0f0fb000   VCRUNTIME140D   (deferred)             
0f740000 0f8b4000   ucrtbased   (deferred)             
74aa0000 74b80000   KERNEL32   (pdb symbols)  

0:000> x kernel32!unhandled*
74ad5f00          KERNEL32!UnhandledExceptionFilterStub (<no parameter info>)
```

程序加载了模块，符号表下号好了，但是只有`KERNEL32!UnhandledExceptionFilterStub`而不是`kernel32!UnhandledExceptionFilter`。这两个API就特么是雷锋跟雷峰塔的关系，死马当活马医，下个断试试

```cpp
0:000> bp kernel32!UnhandledExceptionFilterStub

0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (first chance)
    
0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (!!! second chance !!!)
```

并没有什么卵用，虽然名称中包含了`Filter`，但是异常分发并不走这条路。搜索枯肠，终于在`user32`翻到个`user32!UnhandledExceptionFilter`。虽然是用户态但是黑猫白猫能抓到老鼠就是好猫嘛，名称一样肯定能断下来的~~flag~~

```cpp
0:000> bp user32!UnhandledExceptionFilter

0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (first chance)
    
 0:000> g
(2668.1f30): Integer divide-by-zero - code c0000094 (!!! second chance !!!)
```

![âWTFâçå¾çæç´¢ç"æ](data:image/jpeg;base64,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)

还是死循环...用户态不断的吗，分发直接走的内核态？

### 失败的尝试-3

~~是win10你逼我的~~

在`windbg`中有一条`call`指令可以直接调用某个地址的方法，格式为`.call API(Param1, Param2,..)`。如果在引发异常的时候直接调用异常处理API能不能绕过呢？不过异常处理函数的原型为`LONG WINAPI UnhandledExcept(EXCEPTION_POINTERS *pExpInfo)`，参数需要一个指向异常信息的`EXCEPTION_POINTERS`指针。其原型为

```cpp
typedef struct _EXCEPTION_POINTERS {
  PEXCEPTION_RECORD ExceptionRecord;
  PCONTEXT          ContextRecord;
} EXCEPTION_POINTERS, *PEX
```

在内存里搜搜看

```cpp
0:000> .excr
Unable to get exception context, HRESULT 0x8000FFFF

0:000> .exr -1
ExceptionAddress: 003b19a5 (Breakpoints!main+0x00000075)
ExceptionCode: c0000094 (Integer divide-by-zero)
ExceptionFlags: 00000000
NumberParameters: 0

0:000> s -d esp L1000 0xc0000094
00b3f948  c0000094 00000000 00000000 003ba57c  ............|.;.
00b3f9b4  c0000094 753fa0e0 56fb63e5 2ab7db1f  ......?u.c.V...*

0:000> .exr 00b3f948
ExceptionAddress: 003ba57c (Breakpoints!__dyn_tls_dtor_callback)
ExceptionCode: c0000094 (Integer divide-by-zero)
ExceptionFlags: 00000000
NumberParameters: 3909000

0:000> .exr 00b3f9b4
ExceptionAddress: 2ab7db1f
ExceptionCode: c0000094 (Integer divide-by-zero)
ExceptionFlags: 753fa0e0
NumberParameters: 0
```

在内存中能搜索到结构体的第一个元素`ExceptionRecord`，但是指向其的指针却没有任何踪迹，总不能按每4个字节全部解引用一遍看看内容吧。于是我突然灵机一动

![âçµç¨½ä¸å¨âçå¾çæç´¢ç"æ](data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxIREhUQExAWEBUWEhUWFRgWFRAVFxUVFRUXGBcVFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMtNygtLisBCgoKDg0OFRAQFysdFx0rKysrKy0tKy0rLS0tLS0tLS0tLTctLSstKzctLS0tLSs3LS0rKystLSsrLS0rLSsrK//AABEIAOEA4QMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAAAQIDBAYHBf/EAEwQAAEDAgQCBAkGCQsFAQAAAAEAAgMEEQUSITEGQRMiUWEHFBUycYGRodEjUlRyscEWJEJTVYKSk9IXMzRkc5SywuHi8ENERWOiJf/EABoBAQEAAwEBAAAAAAAAAAAAAAABAgMEBQb/xAAfEQEAAgIDAQEBAQAAAAAAAAAAAQIDEQQSITFBMhP/2gAMAwEAAhEDEQA/APcUREBERAREQEREBQpUIKPKw5hussh0XxzUOkeYwMoG5WnJbqjamq4xqsQxRnafYjaUDQgH1KskDfmj2Bc1s8NkR42I61jjYLZDlztbTnzm9W3Zot7Cq3pG5XbjRY05ETbSdH02jVZwsMazXXf27NcpRERRSoUqgiIgIiICIiAiIglERVRERAREQEREBQVKINTEX2jcexpK+Rg7ruc7tAX18TbeNw7QQvjUAyXbvpuvO5lphYiZnx9O91hkeqtfoqvv6F5X+8N9I/GGZ6+a1+SUAHc/atmrlsFpSOvKwjUXC1Yr2nJ42XrqHXM5LKsMfJZl9Ji/lw2SFKqFZbSBSoUqqIiICIiAiIgIiIJREVUREQEREBQVKgoCIiDDVtu1fCqAWOv2hdBJsvmVlNmuVwczH2qyx21Z8uesDWgna6xT11mXBzArQLwDY/Ot3L51K9pfIMxIvtrYbr5fLW0WepjxRaNvqSVFxa+4X0cKo7ltx2lc9SuL3hg25ehd1QQZWgLt4OK02hzci3kw22tV1UKV9PWuoefMpClQFKQQlSoClZMhERAREQEREBERBKIiqiIiAiIgKCpUFARFF1BSVYHt94Wao2WIjQeha8le0aY705HGA2OQAkNub7r4sTQ1z3PIjHIk+dv/AKe1b3hKjc3ontbf5UA+ixK57HcYjlhbGLCQaWt3hebk4EWnbvpy9V06/hama68w1F7fYuwaNFyvg9ic2mGYWJN/cF1LV14ePFHFfJ2kBVggCldTWkKwVVIKkMoSpUKVlCiIiAiIgIiICIiCURFVEREBERBCglFV42UFkUORQVkVVL1S6jCYYKymZJYPbmAN9b7rS/B2kuXeLtudee/tX0r9yn/m4TcGpY6eEMGVoDR2BZgqC6uE3CdZWUqoVklBWCqrBIZx8SpUKVYUREVBERAREQEREEoiKqIiICIiCpVXK5VSsUkKrdSVgta5JUvOiPZauLYxHTtLnnYd2voXNxeECEuy5XDsuB8Vu47G2UhpsTva9xZadTw1HKAS0NsOWi4cueYnxtijeNfNM3Mywadu1YQ6oH5ZPp2W7h8AZG1o5Dv+9ZHMXLbPZsrVpNxOWMZ5MuX1/etc8f0oOW7nHuyn71nxWmD48pNyTsvkN4ZYwXLRdZY+RbfrG1XWYXjEdQ0OYHajmAvprkcCrhG8RZQNQOXoXVZl6dbxMNFqsisqgKcyyhI+LKVClZQoiIqCIiAiIgIiIJREVUREQEREFSqlWKoSsGEocV8Dip0xp3th8+1xvcahfeJXM4pUnpy1rjqAPWuTkZJiJbcdXwOAmVIYXVV3m9hm3suzY9p2Flz4he21zsLcwvp0bTzGVeZOTbomG1K7sPJVurvVbLTa7KsOM4t8dL2mmu1v5RHM9nfpZdXRPIiYXiz7WJUvZ1SL87rQr5HONwdAPfZYTniFjH2lviCEuHVAIO/NfSp3akA3At71xfTuOt7L6HDdQ8zEF2lhovQ43I3OjJx9Q6++ikKAVYBerDinxdqlQEWaJREVUREQEREBERBKIioIiICIiCpWMrIVjcsWNlJFx9U+1T+t9xXZFcXiLMlSCdi4/YVwcqN1luwz6+qJml1lsB4vZc5BXBtQWu2cbD03C+70rb25rwZ3t1zG2Zz1XOFgM3Ij/VT0gU9lYhd7lpSv5LJPNyC1JTfY8lz33tvpX9ac+9lGB/0k+r7AtRtRmeWjUscb99u9fS4dizzl49fq0+5d/C32hM8x1l2kR0WUqkbdFZfR0+PIskKQoUhbEWREVZCIiAiIgIiIJREVBERAREQVWNyyFUssJYyoVzvFNLmHSAahdIQteogDwWnmtOWu6rjnUvO3gyssDlkvYHsOuqUWMPgJjqQfrnn6yt3FsOfC4vA6vb2d/etPxyOTqSnpB2EZT7d14WTFaJelS1Zfdp8YgeOrK0+tZfGmb522XJT4DE8ktJjHcXELAOFv6y7/AOvitWtfW2IdPWV8LfOma0Hv3XwKnEZZj0cLMrObrcvarwYBSssZHOkPeXD71vS4vE1vRRsyjbt96xjHEyk2014Wtja2NlnvIF3dpIXXcM0ORubmd1z+BYMZZGyZiADqLHWy7tkYboF7HE42vXDmy7nTI1ECkL0Ic0+gUhEWUCwRApWbJCKUQQilEEKURAREQEREBERBUqpVlFlikwgrGspCqGrGYGtWUjZGkHmFy9fwc0jMwm/qXZEKgK1XwVuyraa/Hmb8JqIr9UlS1tQBbIV6ZlB5A+xUMLfmj2Lmvwqt1c1nmlPg9RMbEFouukwrhFjOs8knvt8F1AaByVlKcOInbG2S0tempmxizQs4Ulqhd1a6aJmZWarKrVZUSpUKVlpkIhWNz+66yGRFRrwVcICIiAiIgXUrC6Q9l9Vw1dhmNmV5irWsjLzlHRwnKy5sN9dNPUg79F555Ix79IN/dQ/FPJGPfpBv7qD4oPQ0XnowjHv0g391D8V8bHa7G6F8Rkq2yse/Kfk4hy7ig9ZRY4iSLlcjiNfiokeIqeN0QFw8yRgnQ6ZD6Pepodki8u4bxjFK8FzZxDkfZ1mRu78uq6fFOMYqPLHOJHSW16OKWQHvzMBA56JEDpKqZrG5nODQNyVhklaBmFthr6V5f4QOPqappegjbOHSHKM0E7CQ4EWYS0XPcFnl43w2enbQysqXFsTA5ohqQ8EAXJsL8lEenQHT/mqyLyrhni2mogWiarkh2jY6kqCQeXyhbcnRegYfjInjbKxpDXWtnDoz33DtW7hE9fUKkIFNkNyIQpsllUQApSyhzrLFdLKy5/ifFaimizwQCqdmIyl2WwsTv7FyJ49xYf8Ahm+qf/astrD00rXffYb7rzpvHmLEgeRmjX8//tXocJL2hxGUkAkXvY22RVRUMDwwkBxF8vO2uvuK3AvOa55/CKMX/wCxivrpfpJ+S9ECCyKt1YFUEREGB4OwXIcQVWJRzfi0Beyw1tcE+1dW4kXO3o1PqC4yq45qGSPY2ilkDXEA5HgGx3vZBrnFcc+iD2H+JPKmN/RB+z/uWUcfVX6Ok9kn8Kr+H1URfydINfmv/hQU8q459FH7J/iXLcaVmJSOpxUxGJnSHUAgbekrrHce1X5OHSW7w/8AhXwuJ8cq650EfiUkWV9ycjiNRtq1B65B5oHcvgV/EFII5WmoYwjMDraxFwvuxP6u2tuYsuY4npKWClmnljvob23LidLD0lBy/gux+kZHM104ZaW/WPnaDraexdFxLxPS0obZrZ3vPVjjy9JIDtlvppe/oBXH+B3DqN8DmOaOmLjI5hc4uFrN5m5G3tX3/CJiJpjA6JjS8OsAQ3W1gAHHW9kGXAcJfUzCsq4XR5NYYX7RbEFzdukHaFpYk3xPF5K18RdDJExocAAGlrNSfSVueX8WksGYfEQRmu+fLcd926HuWTo8Wm6ro4qa/wA17Jsvfq3W/uQYsa4vpnRFscbnusejazQmTWwbpobXX3OGqOU0rROQ97nZiHXIDb3a035gHftXyoMPqaUS1NRUtmZHG45TDEzI4WIIcB1h8VuQcWMFIax7JMp2a2MuOm5FtSCsWLq2DRWsvOofCzSZR+L1I0/MSn32WX+Vmk+j1X93l+CulegKV59/KzSfR6r+7y/BQfCzS/R6n+7zfBUegqrl5/8AysUv0ep/cTfBWZ4UaZ5a0Q1IJc1v9Hlt1jbUkLFXcstci3NZAxvYuR4i8pvc11C5rYywHrZAb/rNK4rHuI8Yp6qGk6VpkkvcNER7OxvYUHslm9y5PimLErk0ksLI7gWe15dr2EHa918tsOOm/XYOzWL+FdLw/HViNwqy1zxtbL6tgFR5I6LFPK9rwvqGwM62V5bkzyAaXve+bVdYxnEAaXukpwG62LJeX62ithk+fH5Lm5bRRNOg0Ilkvf2r0Gv/AJqT+zd/hKDkPBlj9RWMm8Yy545ns6gIHVIHNdwAvOfA0Lsqnf1uUe8L0cICIiDWcbE+m64/CuPmyVslDNE6mcDaPNa0guRcWJ5C/rXWv87MBfu+8rmuM+FhW5HNIhmjIdHIACcxsCDtpa+6o61z7clwXEGPynF6WhiflaA58ova7XRSZb69rQvrVeLDD6RstVP0kjWkO0AMjrmwAB7ABp2Lz+m4Vq6yOTFxdtWZCYGuBGWLMNPXG5w23KD2Rs19ANtCuU4s42FHNHTRxOqZpDbo2Wu0WvfUgbLFg2OtrYS2N3QVDBkLHaPzdjmO1bfTW3NX4Q4V8Ve+om+WneTd7uTb3AAuQLXtdB1cMmYfceWmxXB8UVBq62Oia4FsQc+cDNazmHJcelq7iYEtIacpOxAvlPI25rl+FeFDSR1Mkrukmlc8ufbUszOLRv3nRBxvC/Cxnp5Z4H9FVRS2a9uheA2+V53IJtzGy7HGMKZVUjI6wmB7QOuwgPa8Zes1xBtchavgpfeOYHT5W4+rlAWDwxyltIy2g6aIOtvbpmA+5BWnomtY1pxVz8rbaud1u9+mpV/F28sTe223Xdc33v1dR2KsXkhoHyEp0F+rMdbelXEmEfR5v2JkGGswWOoHROxSR7XHrNL/ADx813V1Hcu4pqRjImRBuZoa0WOx2XkvFVRRipo/Fo5GfjLM1xKAd9NV7HS+a0jaw9VgghuFwj/pN9gTyXD+ab7FtgqUGn5Lh/NN9ieTIfzTfYtxEGn5Mh/NN9gUGgibqI2+xbiwVTyBoL/Ac1BV8gaNbNC834JBr6+bE3gFjTkhJBtoC05b67hb/hI4gENN0DHtZPNpHmeGZLg2ldfzW6W1W9w1iWGUVM2BlZT2aCSBLHq52rufM3UG5RcVRPq5aItdG9gzXcRZwzW6tvvX336XPoPsXkfHWN0jailxKnka+SN46TIQ4OYB5riO872Xe49xLFFQuqQ4WdGRHqNXuFgB+toqOY8H8nT4pX1FiLfI62scry7/ADe5eh4o8CCUnYRPv+yVyPgnwp8FG6WQWkqJTO7tGdjBb3LpseP4rUf2En+AoOO8CljTVDhzrZf8q9FXn3gVpejopBmzZqiR3tsV6CgIiJoc/wAQ8S0tCM1RIGX2135LjqjwneMkxUFK+d2gz3YWAXtcgkHt2Xf1uFxSkGRoeRsTyUxUzWHqsby1AA+xUcJgfBFRUSNqcSm6UbthGYMadN2m/YefNeiNgDQA3QDQDkAsgKkIOJ4q4G8Zf41TymlqQNXtJAfz69tSdAvg/hfX4d1K6ldUtaLGWEBrbbAnMb32uvU7LHLGHbi/qQc/wvxhTYg0ugvpvqND2e9fem/mnkG/Vdv6CscVMyO+VoaT2AAf6LPku23cg4XwTSDoZb2v0utvQsXhnlaKJuhJ6eKwFtbSxk+5dth+FxQghjbBxufSq4jhUU7Qx7cwBBHpGqDj4uJoAG//AJsm3/q7u9ZRxZB+jZfZF8V20cY0GULIIx2BB43xljLJqiiDaV9P+Nsu45LW100Xr1GbMbfmPt1Wni+FxTGMyMByOBb9bVfQY21u4aIMgVlVpVkBERBCq4XVkQc7jXB1LVu6SZnSO2GYA2HZtstWDweYcy34pGbAjVjDvz2XWKpQc7PwdRdEYhSxMaR1i1jQfSD2rzaggGI1gpYw/wAQpXecSLOkuHAXG/WDh6l7W4aL5bKFkejW2Jve3ebm/eg+JxXxnBhbYxJGS1wsMuUC+vVHsXJ4n4VIq6J9JSU8j5ZmOjGrLNzjLc69/uXpgjY9tnNFthcXuBsbHmrR0jRYhrb626rRZND4/g9wF1DRxwuN3kBzyfnEC66cLBCzKSLWG+/NZwgIiIMT9ljptkRBD91ljUogko7ZQiDDU+YfqlZYPNb9UfYiIMgVERAbusqIg1a78n6w+wrKPuREF2KyIgIiIIREQFUoiCVrDznelv3IiClfuz6yznzh6ERUZOasERQEREH/2Q==)

传个0作为参数，手动跳过流程，改改寄存器变量值，岂不美哉

```cpp
0:000> .call Breakpoints!UnhandledExcept(0)
Thread is set up for call, 'g' will execute.
WARNING: This can have serious side-effects,
including deadlocks and corruption of the debuggee.

0:000> t
(2668.1f30): Integer divide-by-zero - code c0000094 (first chance)

0:000> t
(2668.1f30): Integer divide-by-zero - code c0000094 (!!! second chance !!!)
```

不行，无法跳转，EIP已经被锁死了，只能从异常分发机制下手，而非对寄存器或执行顺序进行魔改。

![âè¿å¯åæ´åâçå¾çæç´¢ç"æ](data:image/jpeg;base64,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)

但是要么没有一模一样的API，长得像的，用户态的又断不下来，脑壳疼，切换到WIN7试试。

## WIN7

一如既往地中断到`div`指令前，还是一样的错误，还是熟悉的味道

```cpp
(244.5c0): Integer divide-by-zero - code c0000094 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000006 ebx=7ffdf000 ecx=0026f67c edx=00000000 esi=0026f940 edi=0026fa28
eip=013d19a5 esp=0026f940 ebp=0026fa28 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
*** WARNING: Unable to verify checksum for Breakpoints.exe
Breakpoints!main+0x75:
013d19a5 f73538a13d01    div     eax,dword ptr [Breakpoints!flag (013da138)] ds:0023:013da138=00000000
```

首先还是老样子，搜索巨硬提供的系统模块`Kernel32`的符号表中有没有`UnHandledExceptionFilter`这个妖孽

```cpp
0:000> x kernel32!Unhandle*
770eed38 kernel32!UnhandledExceptionFilter = <no type information>
```

![âæTMâçå¾çæç´¢ç"æ](data:image/jpeg;base64,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)

这尼玛...最新版win10巨硬不给符号表，换到win7老实得不得了。~~珍惜生命，远离最新版系统~~

那接下来可就一马平川了，先给`kernel32!UnhandledExceptionFilter`下个断点，然后看看情况

```cpp
0:000> bu kernel32!UnhandledExceptionFilter
0:000> g
Breakpoint 0 hit
eax=770eed38 ebx=00000000 ecx=0026f30f edx=777f70b4 esi=0026f408 edi=00000000
eip=770eed38 esp=0026f3dc ebp=0026faf4 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
kernel32!UnhandledExceptionFilter:
770eed38 6a5c            push    5Ch
```

嗯，看来确实进入了系统分发结构化异常的流程，接下来看看`kernel32!UnhandledExceptionFilter`会调用哪些方法来确定调试器的存在

```assembly
kernel32!UnhandledExceptionFilter:
770eed38 6a5c            push    5Ch
770eed3a 68f0ee0e77      push    offset kernel32!BaseReleaseProcessExePath+0x13b8 (770eeef0)
770eed3f e82cd0feff      call    kernel32!_SEH_prolog4 (770dbd70)
770eed44 c745e006000000  mov     dword ptr [ebp-20h],6
770eed4b 33f6            xor     esi,esi
770eed4d 8975e4          mov     dword ptr [ebp-1Ch],esi
770eed50 8975dc          mov     dword ptr [ebp-24h],esi
770eed53 8975d8          mov     dword ptr [ebp-28h],esi
770eed56 8b5d08          mov     ebx,dword ptr [ebp+8]
770eed59 8b03            mov     eax,dword ptr [ebx]
770eed5b f6400410        test    byte ptr [eax+4],10h
770eed5f 0f8538e0ffff    jne     kernel32!UnhandledExceptionFilter+0x29 (770ecd9d)
770eed65 c745d401000000  mov     dword ptr [ebp-2Ch],1
770eed6c 8138090400c0    cmp     dword ptr [eax],0C0000409h
770eed72 0f8473e0ffff    je      kernel32!UnhandledExceptionFilter+0x3f (770ecdeb)
770eed78 53              push    ebx
770eed79 e843020000      call    kernel32!CheckForReadOnlyResourceFilter (770eefc1)
770eed7e 83f8ff          cmp     eax,0FFFFFFFFh
770eed81 0f841de0ffff    je      kernel32!UnhandledExceptionFilter+0x91 (770ecda4)
770eed87 e8ad010000      call    kernel32!BasepIsDebugPortPresent (770eef39)
770eed8c 85c0            test    eax,eax
770eed8e 0f8509e0ffff    jne     kernel32!UnhandledExceptionFilter+0x29 (770ecd9d)
......
```

该API调用了`kernel32!BasepIsDebugPortPresent`来确定调试器的端口，动态分析得出调用完该API后，`EAX=1`，通过`test`判断非0后经过`jne`跳转到调试器的处理例程中。在`test`指令执行前将EAX清空可以实现调试器隐藏。

![](https://tinytracer-1256246079.cos.ap-guangzhou.myqcloud.com/Debug/db-3.png)

那么这个API又是如何实现调试器情况监视呢？跟进去看看

```assembly
kernel32!BasepIsDebugPortPresent:
770eef39 8bff            mov     edi,edi
770eef3b 55              push    ebp
770eef3c 8bec            mov     ebp,esp
770eef3e 51              push    ecx
770eef3f 8365fc00        and     dword ptr [ebp-4],0
770eef43 6a00            push    0
770eef45 6a04            push    4
770eef47 8d45fc          lea     eax,[ebp-4]
770eef4a 50              push    eax
770eef4b 6a07            push    7
770eef4d 6aff            push    0FFFFFFFFh
770eef4f ff154c150977    call    dword ptr [kernel32!_imp__NtQueryInformationProcess (7709154c)]
.....

```

原来在异常分发的时候，调试器监测的底层实现是`ntdll!NtQueryInformationProcess`。MSDN上关于该API的介绍为：

```cpp
__kernel_entry NTSTATUS NtQueryInformationProcess(
  IN HANDLE           ProcessHandle,
  IN PROCESSINFOCLASS ProcessInformationClass,
  OUT PVOID           ProcessInformation,
  IN ULONG            ProcessInformationLength,
  OUT PULONG          ReturnLength
);
```

> Parameters
>
> ```
> ProcessHandle
> ```
>
> A handle to the process for which information is to be retrieved.
>
> ```
> ProcessInformationClass
> ```
>
> The type of process information to be retrieved. This parameter can be one of the following values from the **PROCESSINFOCLASS** enumeration.
>
> | Value                         | Meaning                                                      |
> | ----------------------------- | ------------------------------------------------------------ |
> | **ProcessBasicInformation** 0 | Retrieves a pointer to a PEB structure that can be used to determine whether the specified process is being debugged, and a unique value used by the system to identify the specified process.Use the [CheckRemoteDebuggerPresent](https://msdn.microsoft.com/e7eb2d48-4ef3-4708-8895-2bc33d2c3e91) and [GetProcessId](https://msdn.microsoft.com/9a024147-8bfe-427a-af12-a63f23328e38) functions to obtain this information. |
> | **ProcessDebugPort** 7        | Retrieves a **DWORD_PTR** value that is the port number of the debugger for the process. A nonzero value indicates that the process is being run under the control of a ring 3 debugger.Use the [CheckRemoteDebuggerPresent](https://msdn.microsoft.com/e7eb2d48-4ef3-4708-8895-2bc33d2c3e91) or [IsDebuggerPresent](https://msdn.microsoft.com/7bc4bcb7-3f85-4349-a1da-c4ebee2d3e3f) function. |

第一个参数为进程的句柄，第二个参数是选定查询信息的类型，第三个参数是指向返回查询结果的指针，第四个参数是信息的长度，第五个参数是返回信息的长度。看看传入的参数信息：

```assembly
0:000> kb
ChildEBP RetAddr  Args to Child              
001af6f4 770eef55 ffffffff 00000007 001af710 ntdll!NtQueryInformationProcess

0:000> dd 001af6f4+8
001af6fc  ffffffff 00000007 001af710 00000004
001af70c  00000000 00000000 001af798 770eed8c
```

第一个参数`FFFFFFFF`是一个伪句柄，只适用于线程内部使用，指向其自身。第二个参数`7`根据表格意为查询调试端口信息，返回地址为`001af710`。通过查看EPROCESS结构体发现其中有`DEBUG_PORT`位域，推测与其有关。

```assembly
0:000> .process
Implicit process is now 7ffd4000

0:000> dt _EPROCESS 7ffd4000
ntdll!_EPROCESS
  ......
   +0x0ec DebugPort        : (null) 
  .....
```

尝试在该位域下一个读写硬件断点，但是函数执行完毕后没有中断，看来与其无关

```assembly
0:000> ba r4 7ffd4000++0x0ec

0:000> p
eax=000000ea ebx=001af7c8 ecx=001af71d edx=777f70b4 esi=00000000 edi=00000000
eip=777f604d esp=001af6f8 ebp=001af714 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!NtQueryInformationProcess+0x5:
777f604d ba0003fe7f      mov     edx,offset SharedUserData!SystemCallStub (7ffe0300)

0:000> p
eax=000000ea ebx=001af7c8 ecx=001af71d edx=7ffe0300 esi=00000000 edi=00000000
eip=777f6052 esp=001af6f8 ebp=001af714 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!NtQueryInformationProcess+0xa:
777f6052 ff12            call    dword ptr [edx]      ds:0023:7ffe0300={ntdll!KiFastSystemCall (777f70b0)}

0:000> p
eax=00000000 ebx=001af7c8 ecx=001af6f4 edx=777f70b4 esi=00000000 edi=00000000
eip=777f6054 esp=001af6f8 ebp=001af714 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!NtQueryInformationProcess+0xc:
777f6054 c21400          ret     14h
```

函数执行完毕后，查看第三个参数指向的地址，非0，意味着系统监测到该程序处于`ring3`级别的调试器下，监测的方法...未知。

```assembly
0:000> dd 001af710 L1
001af710  ffffffff
```

调用完毕后`EAX = 0`。如果在此时将`EAX`置为`0x80000000`，执行完`test`指令后，`zf=1 sf=1,  of=0`，满足下一个`jl`的跳转条件，便可绕过调试器监测。

```assembly
770eef4f ff154c150977    call    dword ptr [kernel32!_imp__NtQueryInformationProcess (7709154c)]
770eef55 85c0            test    eax,eax
770eef57 7c0a            jl      kernel32!BasepIsDebugPortPresent+0x2b (770eef63)
770eef59 837dfc00        cmp     dword ptr [ebp-4],0
770eef5d 0f85f7d20100    jne     kernel32!BasepIsDebugPortPresent+0x26 (7710c25a)
770eef63 33c0            xor     eax,eax
770eef65 c9              leave
770eef66 c3              ret
770eef67 90              nop
```

![](https://tinytracer-1256246079.cos.ap-guangzhou.myqcloud.com/Debug/db-4.png)

不作处理，接着跳转到程序的末尾，API通过清空EAX并自增来返回`1`这个状态，反汇编如下

```assembly
7710c25a 33c0            xor     eax,eax
7710c25c 40              inc     eax
7710c25d c9              leave
7710c25e c3              ret
```

在返回前将`EAX`清空也是一个绕过的方法。

## 回到WIN10

至此本来打算告一段落了，突然想起，如果在win10下对`ntdll!NtQueryInformationProcess`下个断，会不会有意外收获？

```assembly
0:000> bu ntdll!NtQueryInformationProcess

0:000> g
Breakpoint 3 hit
eax=011bf7d8 ebx=00000000 ecx=011bf7dc edx=011bf7e0 esi=011bf860 edi=011bfed8
eip=774d0610 esp=011bf7a8 ebp=011bf848 iopl=0         nv up ei ng nz na po cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000283
ntdll!NtQueryInformationProcess:
774d0610 b819000000      mov     eax,19h
```

嗯，一模一样...但为什么没有`UnHandledExceptionFilter`这个API，看了看调用堆栈明白了...全新的异常分发调用，走的是`KERNELBASE!UnhandledExceptionFilter`。难怪之前`USER32`的那个断点断不下来。依然是熟悉的味道，不过是前缀换成了`KERNELBASE!`。

![âæTMâçå¾çæç´¢ç"æ](data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxISEBURExASFRAWFRkVEhcVFRUYFxsYFxUXGBYVFRYYHSghGBolGxYWIjEhJSkrLi4uGh8zODMsNygtLi0BCgoKDg0OFxAQGzEfHx0tLS0tMzcrLSstNS0tLS0rLS01MS0tKy0tKy0tNy03KystLSstLS0tKy03LS0rLS0tK//AABEIAMIBAwMBIgACEQEDEQH/xAAcAAEAAgIDAQAAAAAAAAAAAAAABggFBwECBAP/xABKEAACAgIAAwYDBAUFDQkBAAABAgADBBEFEiEGBxMxQVFhcYEUIjJSI0JykaEIFWKCsTVDVGNzdIOSk7KzwdIkJTM0U2Sio/AX/8QAGAEBAQEBAQAAAAAAAAAAAAAAAAEDAgT/xAAdEQEAAwEAAwEBAAAAAAAAAAAAAQIRIQMTMTIS/9oADAMBAAIRAxEAPwDeMREBERAREQEREBERAREQEREBE+OTlJWpZ2VVHmSQB/GQjjfeAuzXipzt+dgQo+S+Z+uvrObXiv11Ws2+JrmZldSF7HVEHmWOv/xlUO0mXn8QzLFse23VjeGDzCtF5jrlH4VGvXzPxm1Mjsxn8TR2e1gWUhWckKp9OUDyHl5Ca84v2Q43iUWK9NoxkDM7I9bLyjZZuZTzcmuuj9RJW026tqxWcZLsHwwXXjh75qm07KptygCjbKh1otoE6HsZu/gXY7GxwDy87/mYf2CVFqtKkMpIYHYIJBB9wR5Tavd/3x347LRnFr8fehb1NyD3J/vq/P73xPlHrjdJvOZCxIE5nnwcyu6tbanV63AZGU7BB8iDPRO3BERAREQEREBERAREQEREBERAREQE43OHbQ3NNU9osyuxnrvblZi3I331+8SdAN+EdfTUmrEa3PEg/ZvttZdalNtA53Oues9PmUbqB9TJxKhERATgmdXsABJIAA2SToAe5M0x35dtCaKsfEucKzsbrKyR+EAogceYJJJ1+USaY9feZ3unEubEwlR70OrrH2VRvyIoI5mHqT0Hl1O9Ybsd3gcXtPj3X12UNtVrNSKSeo5gUAIAPuTvR8vOaZyLmd2d2LOzFmY9SWJ2ST7kzcXcTi35Tfe5Bh42wfu/esd+blQsfRdlumjvl89yX3OOq5vUM7Wd4GZlXN+lIQEhQNeh1vWtD6CTzuW4tZkeItmC13h6K3DlCAn9SzmIUn1BAJ16esheH3Z5L8XPDWVlRSXa3X3fAB6WqfJidqAPzHR1oyyvBeEU4mOmPSgSqtdAD+LMfViepPqY/mD+pcC7J/wenX+Xbf7vB1/Gdb87QK3Y1gQjTEBbUO+hBCEtr4lQJG+PdtMnGLuMGrJxkJ5mx8tXtVfRnpKdPoTqSDN7R41VFWRbZy02hSraYgBl5gXIH3V15k9BK5Vt7yuw5wLfHp/ScPtO6LFPMq7JPhs3w9D6ge4MhAMsL379m/FwRmUMwWpg9yKx8N1fS+NyDozg8v3vyk7PQSvUsCb93XeNfwxwnWzDY7sqJ6j3eon8LfDyPr7izXAuNUZlCZFFgepxsEeYPqrD0YeolLpLO73tvdwvIDgs2MxAvq30YfmX2ceh+h6QLbRPjh5SW1pbWwat1Dow8irAFSPmCJ9oCIiAiIgIiICIiAiIgIiICIiBiu1eV4WDk2eq0WEfPkOv46lduF8StX9ckD0br/Hzm7e9vN8LhF531bw0H9axd/w3K/YuSBXvXU/2SSsNm93PExfxCtOTTKruSD06IR5fNhNyCaH7kiBn33OwVK8dtsx0Bz2JrZPwVpsTjvb2qva0jxG8uY7C/QebfwHxnNrxWNl1FZtOQmGReqKWdgqjzJIA/eZEOMd4dFZ5KFe+zyHKNLv5nqfoPrI2vDM7iD81zulXpzdOn9FPT66+smXAuyNOOOigt+Y9W+p/5DUw9t7/AIhr66U/c9RxcDO4gQb3KVb34ajlA9R09/i3X4TXvfXbTjeFw+nXPrxcg+evMVp8D+Jj/V95YhEAGgNASp3e0D/PWZsknxR5+3hpyj5a1NaePJ2eyzt5JnkchEZuvuH7Z4uPS+FkWLU7Wmyp30qNzKi8hf0ba+vnuaUnZCN9fL1/5zVmuZwf9JzZB/vmhV8Kh+Aj9rq/yZQfKZKwgAk+QGz8p5+GX12Uo9RBqZFasjyKkAqR8NT0WLsEe41AiuM3C7clMlK6WuZT4d5RQNa0RXY2ubo3km/M785kOM4VjmvwLKkZSDp61sU1jXNpdgg+QBDDWz59Jie0/AkbHNVo58Tp92ytrwjbIJVawLUGjoMr/d9gJ27EcMrStRWP0VTN4TLkZFoII5dctyjkGj1VdgEe4kkSPiGAltD47KPDsQ1sPTlZSpH7jKlcV7ODETeRcvisu6qqmDv18mu9Kl+GyxPp5kXAJlMu07hs3JI8jkWn99rRAxkRJV3cdkW4nmrT1FCjxMhvasMAVH9JidD6n0lFje6pWHBsMPvfggjf5SxKfTlIkrnzoqCKEUAKoAUDyAA0APhqfSAiIgIiICIiAiIgIiICIiAiIgap/lEZZTh1KA658ld/Ja7D/aVmg8DLJdEP4SwH02JZnvV7F2cTorWt1D1OWVW2FbmAB2w/DodfIzVdHdxm4jFvsJtb0I1YB+yFOx8yN/KSVj6yvZHsldadpWUrJBZm3tuvoPM/Pym0OD9kKKTzkc1n5j1P09B9J5e7HHy1xHOYti2tcSosJJCcqhQNnYG+bpJiBPPTwR9t1tfzzPK8fOuoDoBqfQCNTmeiIxgTRvf/ANjGLDidKE9AmUFH5RpLj8NaUn00vxm8p0uqVlKsoZSCGBGwQRogg+Y1KKQ6md4F2N4hmDmx8O109H0FQ/J3IU/QzcOB3Y4D8bu8NGOJjqjW1NpqzfYCwpGxvkVOViCT+IDy6Tb9daqAFACgaAA0AB5AD0EDSHYXi/E+CgY+fg5JwDsq6L4vg7PU7rJHJ1JKk7HUjflNzcJ4rRk1LdRallTeTIdj5H2PuD1E9nLI7k9icJ7WuWpqbm/G+PbbQzeu28FlDHZ9dwJFEwD9nbv1OKZyDyA/7K4/fZQzH6mfHI7LW26FvFc9k9VRsenfzempX18iIHi7wu32Pw2lgXV8sr+iqB+9s+Tv+VN+p89dNyqdthZizEliSST5kk7JMsF2u7kcexHsw7Xrv6tyWsbEc+fVm+8rH82z8vWaJXg+Q15xlosbIVirVqpZwynRBA35GB4QJZ/uY7IHAwee1dZOQRZYCOqoB+jrPsQCSR7sR6SOd1ndIaGXMz1U3KQaaOjBCOoewjoX9gOg8+p8tyCBzERAREQEREBERAREQEREBERAREQEREBERAREQE+eRaERnboqqWPyA2Z4eO8exsOo3ZNyVV+QLeZPsqjqx+ABM05247667absbEocixHrNznk0HBUtWg2d6J0SR8oG0e7+hvsKX2Lq7JLZVo9Qb251U/soUT5KJJJj+AZtd2LTbUwap61ZCPLXKOnw15amQgIiICIiAke4RjImfm8qgM/gWufUlq2r1/9QP1MkDHXWaW7Rd8NGLnZJxqvtPMlVavzFa+ao3c5B0S43YNEdDo9dagbpE5laMrvv4ox2v2asey1E/xdjO+D348TRgbFxrV9QaypP1Vho/QwLKRIP3fd5ONxQFAppylG2qY72PVq26cw+gI9vWTiAiIgIiICIiAiIgIiICIiAiIgIiICIiAkQ7zO2S8Mw/EAVr7DyUK3lza2WbXXlUdT79B03uS+Vv8A5QvFTZxJKN/copXp/SsPOx/1fD/dA1/x3juTmW+Lk3PbZ6Fj0A9kUdEHwAExsRAm/d73kZHDD4evFwy23rYna782qb9U/A9D8CdyxXZbtpg8QQHHyFL62amPLavvtD1PzGx8ZT6dkcgggkEHYI6EEeRB9IF3wZzKj8O7x+LULy159xH+MK2/xtDGZP8A/sXGf8KT/Y0/9MC0s4ZgBsnQlXF74uMf4Uh/0NP/AEzF9ou8TiWanhX5TeEfxJWFrVv2+QAsPgSR8IGxO93vSVlfBwbAwYcuRcp6EetdTDz36t7dB7jSMRAREQPTw3Psx7UvqcpbWwZGB8iP+Xpr1Blx+zfE/tWJRk6141SWa9iygkfQ7lNcPFe2xKkHNY7BEA9WYhVH1JEuV2b4Z9lxKMbe/BqSvfuVUAn6ncDJREQEREBERAREQEREBERAREQEREBERASqXfMf+/Mv51f8CuWtlXe/TF5ONXN/6iVOP9mE/tQwNfxE7IpJAAJYnQA6kk+QA94HWJajhXdXwlERmwUa0Iofme1lLADmPIXK+Y9pIVx8HDosC1UU0VqbLQqIqgAbLMqjqdCBTabE7B90+VnEWXBsbF6HmZf0j/CtD6f0j069OaWM4fh47ItqUVqGAZf0aq2j1BI0Cp16HrMlA0B2v7jbkJfAsFqefhWsFsHwV+isPny/WQs92HGAdfzfbv8Aar1+/m1LZxArHwjuX4pad2pVjpvqbLFY69wtfN+4kSNdr+GYeLYtGNktkuobx7QvLVzc2glQ8yBo7bZB2NeRlseP2IuLcXsFaeE/M5OgoKkc2/hKWwERJj3a9hreJ5I2pGGjD7RZ1A0OvhqfVz/AHZ9NhN+4fsOzOOJ3LpF2MQH9ZuqtaR7DqB8dn0Bm+p8cPGSqta0ULWihUVRoBVGgAPYCfaAiIgIiICIiAiIgIiICIiAiIgIiICIiAle/5SFKjNxnBHO2OQw9dLY3KT/rN+4ywkrR/KBVxxcc34fs9fJ+zt9//Lm/fA1pJR3YYos4xhqda8dX6+X3NuP92ReTjuXw2s41jFRsV89jn2Va2G/9ZlH1gWc4xxFMbHsvs3yVqWOvM68lUerE6AHuRIfxPBe0YvD7NeNk2fa+Ia6jw6SjPWD6r4hopG/1FMyfGlOXm1Yyn9BjMmTleemf732an2/EpsPtyJ+afbspT4tl3ED1+0FUx/hjVc3gkftlnt+Vi+0CSxEQOrsANk6A6mcgyO9sR4wpwR55Fo8Uf+3qIsv2PVWHJUf8qJ6O13FWxsR3r0b2K1Y6n9a61uSoa9uZgT8AYGn/AOUTx67x6sIErj+ELmA6c7l3Ub9wvJ5e7fATTlFLOwVVLMxCqqjZJPQKoHUkn0lu+Ldi8PLprpyqvG8JQqOxYWdAAT4ikN10CevWcdnOwvD8BufGxlSz87Fnf5BnJKj4DUCCd3/c3jpjrbxGrxcl9MK+dglY9EPIRzt1+9vp6DyJO1sDAqorWqqtK61GlRFCqPkBPTEBERAREQEREBERAREQEREBERAREQEREBEQYHhy+K113VUMT4t3N4agb6IvM7H2UdBv3ZR6yOd4nYCjita8zGu+sEVWKObQPmrrscy70fQj0PUg9eyifas/L4i3WsN9ixP8nSf0zj3DXcw3/ixJkIFcr+4jiIYhb8Rl9CXtU6+K+GdfvM2n2F7E43Bcay53DXeGXybjsAIgLFUH6qjW/c+Z9AJ3MN2jr8XwsYNoWWBrR0601EPYNH0YhKz8LIGH+x2LieH1GXn2k3EHRTxF3Z94D+9UJyKfUqn5pLaKwqhVACgAADyAA0AJj8KvxL3vP4QPCpBHpvdjj9pgo+VakecykBBiYjtVxU4uLZao5reiUL+a6xglKfIuy7+G4Hi4E32jMyMs/wDh1scTGPQ7Ws7yHHtzXDk/0AjPo+0cRpXzqxFN7+ejdYGrpG/Ila/HJHpzIfWZPg+AmLi10gnlqrClj5nlH3nY+5O2J9yZ04DiMiNY41bc5tsHsW0FQ+/Iiom/6O/WBlIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAmC7X8SeqgV0/+byG8DGHs7Ak2H+iiBnP7PxmdMxdeIHyTkN15FNVXwBINrD9oqi/6P+lA+vA+F14uNVjVj9HUgRfc6HUn4k7J+JnviIAzD8PRbrbr+ba9aK9HyWtmW3WvJjYGB+Fae0y7DpPNgYqU1rUm+VRrr1J9SzH1YnZJ9STA+9VYVQoGgBoD2A8hO84BnMBI1lH7TxNKvOrDTx389G+0MlK/ErWLWI/p1mSN20NzF9n+HmpbLGH6W+1rrPfrpa0/qVrWn9Un1gZQoCNTkCcxAREQEREBERAREQEREBERAREQEREBERAREQEREDgicKup2iAnBOpzOtnl1gaf7X8es2hTtJQ1VuVXU1eMcZGroschrDaGZgVX9foPWejtJn8PoxsOrH4nVdy8Sx7bGbMS6zl5/wBI7tzEhNefkB1nh7ecb4MwxUxUxrLVzcd7Fx6AxatWPOm1XTb2AF396e/tbipdwvJyE4MMTwDVfUba6EssWuwNaGRNlByKeh89wMxw7idNXEAcfjOJdi5Dk20W5ddjpYw+6cQhidM2h4Z6DfT2nbtNxHjuMmRkIvCji0iyxQ32nxTWgLDYBC8/KPcDc47MnGzc2yzGxMQcOoCqloor3ZkbDFqnA6Kg0N+pPSSDt9/crO/zS/8A4TQI52b4lx7Krx8hl4UMW0V2MB9pForYgtobK8/Lv11uduDdu7H47kcLtWtal2MZ1DBmZVV2RyWIJ5Sx6Afhme7uf7kYP+bVf7gmuOKYDvdxfKpG8rCzacqnW+orq/SoddSDXzdPXQgbky8lK62sdgtaKWdj5BVBJP7hIZ3WdsbuKV5FttaIK7QtSqGB5GUMvOSTttEdRoTyduOLDOxcPDx2IPEmUlh5rjBRZe3l0OtLo+5np7t6lTL4qigBVzAqgeQAqUAD6CBO4iICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgJwROYga47aZKW24uDjYl/PVxDHssK47rSK625mfxQOTQB9/eZDi+BxHiL2Y9gXD4cGZLCrh8jITy0pA5aa2G/dv3mTeIGrOHJn432fg6UXKteUrJl1qPCbDVjY3Ow/DaRpCpHXe+u5P+1HDmycLJx0Kh7qLKkLEhQzoVBYgEgbPoDMpEDE9k+Gvi4OPjWFTZVSlblSSpKqASpIB19BMd2d7PWUZfELrDW1eVaj1gFiQq1lSLAVAH0JkniBAew/YF8HLuusuWypQasBQWJqoexrWVtjW+YgdN+R69dDJ8D4Bk49nEbFennyrjbjdWIU+Hyr4o0P1gNgE9PWSuIEZvp4r/ADcipdifzmOXndlbwT9772gF2Pu69PPfl6e7iKZpycY0vQMUc/2sOG8Rvujk8LQ1578yPrMxEDDivN+3Fi9H83+DoLpvG8bm8961y636+3T1nwwKuIhMrxbcY2F3+w8oblVNHwvG6Ak71vW/XqZn4gY/gKZIxqxltW2UF/StUCEJ2fwggemvQddzIREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERA//Z)

~~网络上东拼西凑的教程害skr人，不过在64位系统下找kernel32.....我蠢了~~

```assembly
0:000> kp
 # ChildEBP RetAddr  
00 003af0b0 754f9d74 ntdll!NtQueryInformationProcess
01 003af0d4 754fa1d1 KERNELBASE!BasepIsDebugPortPresent+0x1d
02 003af16c 77502fff KERNELBASE!UnhandledExceptionFilter+0xf1
03 003af9dc 774c65fd ntdll!__RtlUserThreadStart+0x3ca01
04 003af9ec 00000000 ntdll!_RtlUserThreadStart+0x1b
```

还是一样的配方，还是熟悉的味道，修改`KERNELBASE!BasepIsDebugPortPresent`的返回结果，大功告成。

![](https://tinytracer-1256246079.cos.ap-guangzhou.myqcloud.com/Debug/db-5.png)

# 总结

玩了一遍Windows调试器监视与异常分发的流程，熟悉了与调试/反调试相关的API。不过..由于网上资料质量参差不齐，走了太多的弯路，心情如图。

![âæTMâçå¾çæç´¢ç"æ](data:image/jpeg;base64,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)